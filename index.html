<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            html, body{
                width:100%;
                display: flex;
                flex-direction: row;
            }
            canvas{
                background-color: whitesmoke;
            }
            #hint{
                border: blueviolet solid 2px;
                border-radius: 20px;
                text-align: center;
            }
            table {
            border-collapse: collapse;
            }
            table td, table th {
            border: 1px solid rgba(137, 43, 226, 0.603);
            }
            table tr:first-child th {
            border-top: 0;
            }
            table tr:last-child td {
            border-bottom: 0;
            }
            table tr td:first-child,
            table tr th:first-child {
            border-left: 0;
            }
            table tr td:last-child,
            table tr th:last-child {
            border-right: 0;
            }
        </style>
    </head>
    <body>
        <div>
            <canvas id="myCanvas" width=1200 height=800>

            </canvas>
            <div id='hint'> 
                <p>
                    <!-- Подсказка -->
                </p>
            </div>
        </div>
        <div style="display: none">
            <div>
                    <p>Scale:</p>
                    <p id="scale"></p> 
            </div>
            <button style="width: 4vw" id='minus'>-</button>
            <button style="width: 4vw" id='plus'>+</button>
        </div>
        <script>
            var data = {
                parts:5 ,
                names:[
                    'Lorem ipsum dolor sit amet.',
                    'Lorem ipsum dolor sit amet.',
                    'Lorem ipsum dolor sit amet.',
                    'Lorem ipsum dolor sit amet.',
                    'Lorem ipsum dolor sit amet.',
                    'Lorem ipsum dolor sit amet.',
                    'Lorem ipsum dolor sit amet.',
                ],
                circles:[
                    {
                        name:'sloy1',
                        qr:[
                            [
                                {
                                    mark:1,
                                    n:7,
                                    size:'medium',
                                    color:"green",
                                },
                                {
                                    mark:1,
                                    n:5,
                                    size:'small',
                                    color:"red",
                                },
                                {
                                    mark:2,
                                    n:7,
                                    size:'medium',
                                    color:"yellow",
                                },
                                {
                                    mark:2,
                                    n:5,
                                    size:'big',
                                    color:"red",
                                    stroke:'stroke',
                                },
                                {
                                    mark:1,
                                    n:9,
                                    size:'medium',
                                    color:"red",
                                },
                                {
                                    mark:3,
                                    n:5,
                                    size:'small',
                                    color:"green",
                                },
                                {
                                    n:7,
                                    size:'small',
                                    color:"red",
                                },
                                {
                                    n:5,
                                    size:'small',
                                    color:"red",
                                    stroke:'stroke',
                                },
                                {
                                    mark:3,
                                    n:9,
                                    size:'medium',
                                    color:"purple",
                                },
                            ],
                            [],
                            [],
                            [
                                {
                                    mark:2,
                                    n:0,
                                    size:'big',
                                    color:"red",
                                },
                            ],
                        ]
                    },
                    {
                        name:'sloy2',
                        qr:[
                            [
                                {
                                    n:10,
                                    size:'medium',
                                    color:"green",
                                },
                                {
                                    n:5,
                                    size:'small',
                                    color:"yellow",
                                },
                                {
                                    mark:2,
                                    n:6,
                                    size:'small',
                                    color:"yellow",
                                },
                                {
                                    n:16,
                                    size:'big',
                                    color:"red",
                                },
                                {
                                    mark:2,
                                    n:4,
                                    size:'big',
                                    color:"green",
                                },
                                {
                                    n:10,
                                    size:'small',
                                    color:"green",
                                    stroke:'stroke',
                                },
                                {
                                    mark:1,
                                    n:5,
                                    size:'medium',
                                    color:"green",
                                },
                                {
                                    n:6,
                                    size:'medium',
                                    color:"red",
                                },
                                {
                                    n:16,
                                    size:'small',
                                    color:"red",
                                },
                                {
                                    mark:3,
                                    n:4,
                                    size:'small',
                                    color:"yellow",
                                },
                                
                                {
                                    n:16,
                                    size:'small',
                                    color:"red",
                                },
                                {
                                    n:4,
                                    size:'small',
                                    color:"green",
                                },
                            ],
                            [
                                {
                                    n:9,
                                    size:'medium',
                                    color:"green",
                                },
                                {
                                    mark:3,
                                    n:4,
                                    size:'medium',
                                    stroke:'stroke',
                                    color:"red",
                                },
                                {
                                    n:3,
                                    size:'medium',
                                    color:"green",
                                },
                                {
                                    n:"23",
                                    size:'big',
                                    color:"red",
                                },
                            ],
                            [   {
                                    n:"5",
                                    size:'big',
                                    color:"green",
                                },
                                {
                                    n:6,
                                    size:'medium',
                                    color:"yellow",
                                },
                                {
                                    n:7,
                                    size:'small',
                                    color:"blue",
                                },
                                {
                                    mark:2,
                                    n:8,
                                    size:'big',
                                    color:"green",
                                },
                            ],
                            [
                                {
                                    n:33,
                                    size:'medium',
                                    color:"green",
                                },
                                {
                                    mark:3,
                                    n:4,
                                    size:'medium',
                                    stroke:'stroke',
                                    color:"red",
                                },
                                {
                                    mark:3,
                                    n:5,
                                    size:'big',
                                    color:"green",
                                },
                                {
                                    n:3,
                                    size:'big',
                                    color:"green",
                                },
                            ],
                        ]
                    },
                    {
                        name:'sloy3 ',
                        qr:[
                            [
                                {
                                    mark:2,
                                    n:6,
                                    size:'medium',
                                    stroke:'stroke',
                                    color:"green",
                                },
                                {
                                    n:5,
                                    size:'small',
                                    color:"green",
                                }
                            ],
                            [],
                            [],
                            [
                                {
                                    n:4,
                                    size:'small',
                                    color:"red",
                                },
                                {
                                    mark:3,
                                    n:8,
                                    size:'small',
                                    color:"green",
                                },
                                {
                                    n:8,
                                    size:'big',
                                    color:"red",
                                },
                                {
                                    mark:2,
                                    n:5,
                                    size:'small',
                                    color:"green",
                                },
                                {
                                    mark:3,
                                    n:9,
                                    size:'small',
                                    color:"green",
                                },
                                {
                                    mark:1,
                                    n:6,
                                    size:'small',
                                    color:"red",
                                },
                                
                            ],
                            [

                            ],
                            [
                                {
                                    n:6,
                                    size:'medium',
                                    color:"yellow",
                                },
                            ],
                            [
                                {
                                    n:6,
                                    size:'medium',
                                    color:"red",
                                },
                            ]
                        ]
                    }
                ],
            };
            
            const getContext = () => document.getElementById('myCanvas').getContext('2d');
            
            var scale = 0.7;
            var circles = [];
            var shapes = [];
            var w=document.getElementById('myCanvas').width, h=document.getElementById('myCanvas').height;
            var leftOffset = document.getElementById('myCanvas').offsetLeft;
            var topOffset = document.getElementById('myCanvas').offsetTop;
            var ctx = getContext();

            document.getElementById('plus').onclick = function() {
                scale+=0.1
                init(true);
            };
            document.getElementById('minus').onclick = function() {
                if(scale > 0.65)scale-=0.1
                init(true);
            };
            const star = options =>{
                var starPath = new Path2D();
                if(options.size == 'small') r=4,R=8;
                else if(options.size == 'medium') r=6,R=12;
                else if(options.size == 'big') r=8,R=16;
                var ctx = getContext();
                //ctx.globalCompositeOperation = "source-over";
                if(options.color !== undefined){
                    if(!options.grad){
                        ctx.fillStyle = options.color;
                    }else{
                        var gradient = ctx.createRadialGradient(options.x,options.y, 2,options.x,options.y,8);
                        gradient.addColorStop(0, 'white');
                        gradient.addColorStop(1, options.color);
                        ctx.fillStyle = gradient;
                    }
                        
                }
                if(options.n != 0){
                    for(var i = 0,a = 0; i<2*options.n+1;i++,a += Math.PI / options.n){
                        var l = i % 2 == 0 ? r*scale : R*scale;
                        if(i==0){
                            starPath.moveTo(options.x + l * Math.cos(a),options.y + l * Math.sin(a));
                            continue;
                        }
                        starPath.lineTo(options.x + l * Math.cos(a),options.y + l * Math.sin(a));
                    };
                }else{
                    starPath.arc(options.x,options.y,r,0 * Math.PI, 2 * Math.PI)
                }
                starPath.closePath();
                if(options.stroke == 'stroke') ctx.stroke(starPath);
                else  ctx.fill(starPath);
                shapes.push({
                    path:starPath,
                    hint:options.hint,
                    x:options.x,
                    y:options.y,
                    size:options.size,
                    color:options.color,
                    n:options.n,
                    mark:options.mark,
                    circle:options.circle,
                });
                ctx.fillStyle = 'black';
            };
            var degrees = (len, rad)=>{
                return 360*len/(2*rad*Math.PI);
            }

            function wrapText(context, text, marginLeft, marginTop, maxWidth)
            {
                var txt = [];
                function getFontHeight(font) {
                    var parent = document.createElement("span");
                    parent.appendChild(document.createTextNode("height"));
                    var block = document.createElement("div");
                    block.setAttribute("id", "hg");
                    document.body.appendChild(block);
                    document.getElementById('hg').appendChild(parent);
                    parent.style.cssText = "font: " + font + "; white-space: nowrap; display: inline;";
                    var height = parent.offsetHeight;
                    document.body.removeChild(block);
                    return height;
                }
                context.font = "1em serif";
                var lineHeight = getFontHeight("serif");
                var words = text.split(" ");
                var countWords = words.length;
                var line = "";
                for (var n = 0; n < countWords; n++) {
                    var testLine = line + words[n] + " ";
                    var testWidth = context.measureText(testLine).width;
                    if (testWidth > maxWidth) {
                        txt.push(line)
                        line = words[n] + " ";
                    }
                    else {
                        line = testLine;
                    }
                }
                txt.push(line)
                marginTop -= lineHeight*(txt.length/2)-15   ;
                for(var i = 0 ; i<txt.length; i++){
                    context.fillText(txt[i], marginLeft-maxWidth/2+20, marginTop);
                    marginTop+=lineHeight;
                }
            }

            init(true);
            function init(editCircles){
                ctx.clearRect(0,0,w,h)
                shapes = [];
                if(editCircles)circles=[];
                var partDegree = 360/data.parts;
                var alpha = (180-partDegree)/2;
                for(var i = 0; i<data.circles.length; i++){
                    if(circles[i]===undefined) circles[i]=0;
                    
                    var circle = data.circles[i];
                    if(i!=0 && editCircles) circles[i] += circles[i-1] 
                    var radius = i==0?0:circles[i-1];
                    if(editCircles) var delta = 0;
                    else var delta = (circles[i]-circles[i-1]);

                    for(var p = 0; p < data.parts; p++){
                        var part = circle.qr[p];
                        if(part === undefined) continue;
                        var ply = 1;
                        if(delta < 18){
                            circles[i] +=18*scale;
                            delta+=18*scale;
                        }
                        if(i==0 && data.parts !=4) ply=2;
                        for(var k=0, num = degrees(14, radius+24*scale*ply);k<part.length;k++, num += degrees(26, radius+24*scale*ply)){
                            if(k==0 && i==0) {
                                num=partDegree/2;
                            }
                            if(num+5*scale>degrees(2*(radius+24*scale*ply)*Math.cos(alpha* Math.PI / 180), radius+24*scale*ply)){
                                num = degrees(14, radius+24*scale*ply);
                                ply+=1;
                            }
                            if(24*scale*ply > delta){
                                circles[i] +=20*scale;
                                delta +=20*scale;
                            }
                            x=w/2+(radius+26*scale*ply-12*scale)*Math.sin((num+partDegree*p) * Math.PI / 180);
                            y=h/2+(radius+26*scale*ply-12*scale)*Math.cos((num+partDegree*p) * Math.PI / 180);
                            
                            star({
                                n:part[k].n,
                                size:part[k].size,
                                x:x,
                                y:y,
                                color:part[k].color,
                                hint:'Это фигура'+k,
                                mark:part[k].mark,
                                circle:i,
                                stroke:part[k].stroke,
                            })
                        }
                    }
                }
                
                for(var i = 0; i < data.parts; i++){
                    ctx.beginPath();
                    ctx.moveTo(w/2,h/2);
                    ctx.lineTo(
                        w/2+(circles[circles.length-1]+20)*Math.sin((partDegree*i) * Math.PI / 180),
                        h/2+(circles[circles.length-1]+20)*Math.cos((partDegree*i) * Math.PI / 180)
                    );
                    ctx.stroke();
                    if(data.names[i] !== undefined) {
                        x = w/2+(circles[circles.length-1]+120)*Math.sin((partDegree*i+partDegree/2) * Math.PI / 180);
                        y = h/2+(circles[circles.length-1]+120)*Math.cos((partDegree*i+partDegree/2) * Math.PI / 180);
                        wrapText(getContext(), data.names[i], x,y,200)
                    }
                } 
                for(var i = 0; i < circles.length; i++){
                    ctx.beginPath();
                    ctx.arc(w/2,h/2,circles[i],0 * Math.PI, 2 * Math.PI)
                    ctx.stroke();
                }
            }
            function addTable(s){
                if(document.getElementsByTagName('table')[0] !== undefined) document.getElementsByTagName('table')[0].remove()
                var t = document.createElement('table');
                t.style.width = '30vw'
                var thead = document.createElement('thead');
                t.appendChild(thead);
                thead.innerHTML = `
                <tr>
                    <th></th>
                    <th>N</th>
                    <th>Size</th>
                    <th>Color</th>
                    <th>Hint</th>
                    <th>Mark</th>
                </tr>
                `
                var table = document.createElement('tbody');
                t.appendChild(table);
                
                for(var i = 0; i < s.length; i++){
                    if(s[i] === undefined) continue
                    if(s[i].ss.length == 0) continue
                    td = document.createElement('td');
                    tr = document.createElement('tr');
                    td.style.verticalAlign = 'baseline'
                    td.style.width = '5vw'
                    td.innerText = s[i].name+':';
                    tr.appendChild(td);
                    table.appendChild(tr);
                    for(var j = 0; j < s[i].ss.length; j++){
                        tr = document.createElement('tr');
                        tr.appendChild(document.createElement('td'));
                        //if(s[i].ss[j].hint === undefined) continue;
                        for (key in s[i].ss[j]){
                            if(key == '0'){
                               continue
                            }
                            td = document.createElement(s[i].ss[j][0]=='bold'?'th':'td');
                            td.style.verticalAlign = 'baseline';
                            td.innerHTML = s[i].ss[j][key];
                            tr.appendChild(td);
                        }
                        table.appendChild(tr);
                    }
                }
                document.getElementById('hint').appendChild(t)
            }
            
            var index, oldIndex;
            var editedShapes = [];
            document.getElementById('myCanvas').addEventListener('mousemove',(e)=> {
                
                var yep = false, lay=false;
                var x = e.pageX - leftOffset,
                    y = e.pageY - topOffset;
                ctx = getContext();
               
                var shape;
                for(var i = 0; i < shapes.length; i++){
                    yep = ctx.isPointInPath(shapes[i].path, x, y);
                    if(yep){
                        shape = shapes[i];
                        break;
                    }
                }
                cx = x-w/2;
                cy = y-h/2;
                for(var i = 0; i < circles.length; i++){
                    if(circles[circles.length-1] < Math.sqrt(cx*cx+cy*cy)){
                        index = 0, oldIndex = 1;
                        break;
                    }
                    function lay(rad0, rad1){
                        ctx.beginPath();
                        ctx.arc(w/2,h/2,rad1,0 * Math.PI, 2 * Math.PI)
                        ctx.arc(w/2,h/2,rad0,0 * Math.PI, 2 * Math.PI, true)
                        ctx.globalCompositeOperation = "destination-over";
                        ctx.fillStyle = '#ffb5fb'
                        ctx.fill();
                        ctx.globalCompositeOperation = "source-over";
                        lay = true;
                        if(index !== undefined){
                            oldIndex = index;
                            index = i;
                        }else{
                            index = i;
                            oldIndex = i;
                        }
                    }
                    if(i!=0) {
                        if(circles[i-1] <= Math.sqrt(cx*cx+cy*cy) && circles[i] >= Math.sqrt(cx*cx+cy*cy)){
                            lay(circles[i], circles[i-1]);
                            document.getElementsByTagName('p')[0].innerText = data.circles[i].name;
                        }
                    }else{
                        if(0 <= Math.sqrt(cx*cx+cy*cy) && circles[i] > Math.sqrt(cx*cx+cy*cy)){
                            lay(circles[i], 0);
                            document.getElementsByTagName('p')[0].innerText = data.circles[i].name;
                        }
                    }
                }
                if (yep) {
                    //document.getElementsByTagName('p')[0].innerText = shape.hint;
                    star({
                        n:shape.n,
                        size:shape.size,
                        x:shape.x,
                        y:shape.y,
                        color:shape.color,
                        hint:'Это фигура',
                        grad:true,
                        circle:shapes[i].circle,
                    })
                    if(editedShapes.indexOf(shapes.indexOf(shape)) == -1) editedShapes.push(shapes.indexOf(shape));
                    
                    if(shape.mark!==undefined){
                        for(var i = 0; i < shapes.length; i++){
                            if(shapes[i].mark!==undefined && shapes[i].mark == shape.mark){
                                star({
                                    n:shapes[i].n,
                                    size:shapes[i].size,
                                    x:shapes[i].x,
                                    y:shapes[i].y,
                                    color:shapes[i].color,
                                    hint:'Это фигура',
                                    grad:true,
                                    circle:shapes[i].circle,
                                })
                                if(editedShapes.indexOf(i) == -1)editedShapes.push(i);
                            }
                        }
                    }
                    var s = [];
                    for(var i = 0; i < editedShapes.length; i++){
                        shape = shapes[editedShapes[i]];
                        if(s[shape.circle] === undefined){
                            s[shape.circle] = {};
                            s[shape.circle].name = data.circles[shape.circle].name;
                            s[shape.circle].ss = [];
                        }
                        s[shape.circle].ss.push({
                            0:i==0?'bold':'nope',
                            n:shape.n,
                            size:shape.size,
                            color:shape.color,
                            hint:shape.hint,
                            mark:shape.mark?shape.mark:'-',
                        })
                    }
                    addTable(s);
                }else if(index!=oldIndex){
                    document.getElementsByTagName('p')[0].innerText = "|";
                    init(false);
                }else if(!yep){
                    for(var i = 0; i < editedShapes.length; i++){
                        star({
                            n:shapes[editedShapes[i]].n,
                            size:shapes[editedShapes[i]].size,
                            x:shapes[editedShapes[i]].x,
                            y:shapes[editedShapes[i]].y,
                            color:shapes[editedShapes[i]].color,
                            hint:'Это фигура',
                        })
                    }
                    editedShapes = [];
                if(document.getElementsByTagName('table')[0] !== undefined) document.getElementsByTagName('table')[0].remove();                    
                }
            });
            
        </script>
    </body>
</html>